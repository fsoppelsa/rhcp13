# certain initialization steps (run in a container) will occur
# on the role marked as primary controller or the first role listed# On upgrade certain roles can be disabled for operator driven upgrades
  # See major_upgrade_steps.j2.yaml and post-upgrade.j2.yaml# primary role is: ControllerDeployedServer
heat_template_version: queens

description: >
  Post-deploy configuration steps via puppet for all roles,
  as defined in ../roles_data.yaml

parameters:
  servers:
    type: json
    description: Mapping of Role name e.g Controller to a list of servers
  stack_name:
    type: string
    description: Name of the topmost stack
  role_data:
    type: json
    description: Mapping of Role name e.g Controller to the per-role data
  DeployIdentifier:
    default: ''
    type: string
    description: >
      Setting this to a unique value will re-run any deployment tasks which
      perform configuration on a Heat stack-update.
  EndpointMap:
    default: {}
    description: Mapping of service endpoint -> protocol. Typically set
                 via parameter_defaults in the resource registry.
    type: json
  ConfigDebug:
    default: false
    description: Whether to run config management (e.g. Puppet) in debug mode.
    type: boolean
  DockerPuppetDebug:
    type: string
    default: ''
    description: Set to True to enable debug logging with docker-puppet.py
  DockerPuppetProcessCount:
    type: number
    default: 3
    description: Number of concurrent processes to use when running docker-puppet to generate config files.
  ctlplane_service_ips:
    type: json
  blacklisted_ip_addresses:
    description: List of IP addresses belong to blacklisted servers
    type: comma_delimited_list
    default: []
  blacklisted_hostnames:
    description: List of hostnames belong to blacklisted servers
    type: comma_delimited_list
    default: []
  FastForwardUpgradeReleases:
    type: comma_delimited_list
    default: ['ocata', 'pike', 'queens']
    description: List of releases to fast forward through during upgrade. Last release in list is used for post steps.
  ssh_known_hosts_hostnames:
    description: Mapping of hostname to ssh known hosts entry
    type: json

conditions:

  WorkflowTasks_Step1_Enabled:
    or:
      - not:
          equals:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks, step1]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks, step1]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks, step1]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks, step1]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks, step1]
            - ''
      - False

  WorkflowTasks_Step2_Enabled:
    or:
      - not:
          equals:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks, step2]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks, step2]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks, step2]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks, step2]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks, step2]
            - ''
      - False

  WorkflowTasks_Step3_Enabled:
    or:
      - not:
          equals:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks, step3]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks, step3]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks, step3]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks, step3]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks, step3]
            - ''
      - False

  WorkflowTasks_Step4_Enabled:
    or:
      - not:
          equals:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks, step4]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks, step4]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks, step4]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks, step4]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks, step4]
            - ''
      - False

  WorkflowTasks_Step5_Enabled:
    or:
      - not:
          equals:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks, step5]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks, step5]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks, step5]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks, step5]
            - ''
      - False
      - not:
          equals:
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks, step5]
            - ''
      - False


resources:

  RoleConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ansible
      options:
        modulepath: /usr/share/ansible-modules
      inputs:
        - name: step
        - name: role_name
        - name: update_identifier
        - name: bootstrap_server_id
        - name: enable_debug
        - name: docker_puppet_debug
        - name: docker_puppet_process_count
        - name: role_data_step_config
        - name: role_data_puppet_config
          type: Json
        - name: role_data_docker_config_scripts
          type: Json
        - name: role_data_docker_puppet_tasks
          type: Json
        - name: role_data_docker_config
          type: Json
        - name: role_data_kolla_config
          type: Json

      config:
        str_replace:
          template: |
            - hosts: localhost
              connection: local
              tasks:
              _TASKS
          params:
            _TASKS: {get_file: deploy-steps-tasks.yaml}

  ExternalDeployTasks:
    type: OS::Heat::Value
    properties:
      type: comma_delimited_list
      value:
        yaql:
          # processing from per-role unique tasks into globally unique tasks
          expression: coalesce($.data, []).flatten().distinct()
          data:
            - get_param: [role_data, ControllerDeployedServer, external_deploy_tasks]
            - get_param: [role_data, ComputeDeployedServer, external_deploy_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, external_deploy_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, external_deploy_tasks]
            - get_param: [role_data, CephStorageDeployedServer, external_deploy_tasks]

  ExternalPostDeployTasks:
    type: OS::Heat::Value
    properties:
      type: comma_delimited_list
      value:
        yaql:
          # processing from per-role unique tasks into globally unique tasks
          expression: coalesce($.data, []).flatten().distinct()
          data:
            - get_param: [role_data, ControllerDeployedServer, external_post_deploy_tasks]
            - get_param: [role_data, ComputeDeployedServer, external_post_deploy_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, external_post_deploy_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, external_post_deploy_tasks]
            - get_param: [role_data, CephStorageDeployedServer, external_post_deploy_tasks]
# BEGIN workflow_tasks handling
  WorkflowTasks_Step1:
    type: OS::Mistral::Workflow
    condition: WorkflowTasks_Step1_Enabled
    depends_on:
      - ControllerDeployedServerPreConfig
      - ControllerDeployedServerArtifactsDeploy
      - ComputeDeployedServerPreConfig
      - ComputeDeployedServerArtifactsDeploy
      - BlockStorageDeployedServerPreConfig
      - BlockStorageDeployedServerArtifactsDeploy
      - ObjectStorageDeployedServerPreConfig
      - ObjectStorageDeployedServerArtifactsDeploy
      - CephStorageDeployedServerPreConfig
      - CephStorageDeployedServerArtifactsDeploy
    properties:
      name: {list_join: [".", ["tripleo", {get_param: stack_name}, "workflow_tasks", "step1"]]}
      type: direct
      tags:
      - tripleo-heat-templates-managed
      - {get_param: stack_name}
      tasks:
        yaql:
          expression: $.data.where($ != '').select($.get('step1')).where($ != null).flatten()
          data:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks]
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks]

  WorkflowTasks_Step1_Execution:
    type: OS::TripleO::WorkflowSteps
    condition: WorkflowTasks_Step1_Enabled
    depends_on: WorkflowTasks_Step1
    properties:
      actions:
        CREATE:
          workflow: { get_resource: WorkflowTasks_Step1 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
        UPDATE:
          workflow: { get_resource: WorkflowTasks_Step1 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
      always_update: true
# END workflow_tasks handling

# BEGIN workflow_tasks handling
  WorkflowTasks_Step2:
    type: OS::Mistral::Workflow
    condition: WorkflowTasks_Step2_Enabled
    depends_on:
      - ControllerDeployedServerDeployment_Step1
      - ComputeDeployedServerDeployment_Step1
      - BlockStorageDeployedServerDeployment_Step1
      - ObjectStorageDeployedServerDeployment_Step1
      - CephStorageDeployedServerDeployment_Step1
    properties:
      name: {list_join: [".", ["tripleo", {get_param: stack_name}, "workflow_tasks", "step2"]]}
      type: direct
      tags:
      - tripleo-heat-templates-managed
      - {get_param: stack_name}
      tasks:
        yaql:
          expression: $.data.where($ != '').select($.get('step2')).where($ != null).flatten()
          data:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks]
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks]

  WorkflowTasks_Step2_Execution:
    type: OS::TripleO::WorkflowSteps
    condition: WorkflowTasks_Step2_Enabled
    depends_on: WorkflowTasks_Step2
    properties:
      actions:
        CREATE:
          workflow: { get_resource: WorkflowTasks_Step2 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
        UPDATE:
          workflow: { get_resource: WorkflowTasks_Step2 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
      always_update: true
# END workflow_tasks handling

# BEGIN workflow_tasks handling
  WorkflowTasks_Step3:
    type: OS::Mistral::Workflow
    condition: WorkflowTasks_Step3_Enabled
    depends_on:
      - ControllerDeployedServerDeployment_Step2
      - ComputeDeployedServerDeployment_Step2
      - BlockStorageDeployedServerDeployment_Step2
      - ObjectStorageDeployedServerDeployment_Step2
      - CephStorageDeployedServerDeployment_Step2
    properties:
      name: {list_join: [".", ["tripleo", {get_param: stack_name}, "workflow_tasks", "step3"]]}
      type: direct
      tags:
      - tripleo-heat-templates-managed
      - {get_param: stack_name}
      tasks:
        yaql:
          expression: $.data.where($ != '').select($.get('step3')).where($ != null).flatten()
          data:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks]
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks]

  WorkflowTasks_Step3_Execution:
    type: OS::TripleO::WorkflowSteps
    condition: WorkflowTasks_Step3_Enabled
    depends_on: WorkflowTasks_Step3
    properties:
      actions:
        CREATE:
          workflow: { get_resource: WorkflowTasks_Step3 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
        UPDATE:
          workflow: { get_resource: WorkflowTasks_Step3 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
      always_update: true
# END workflow_tasks handling

# BEGIN workflow_tasks handling
  WorkflowTasks_Step4:
    type: OS::Mistral::Workflow
    condition: WorkflowTasks_Step4_Enabled
    depends_on:
      - ControllerDeployedServerDeployment_Step3
      - ComputeDeployedServerDeployment_Step3
      - BlockStorageDeployedServerDeployment_Step3
      - ObjectStorageDeployedServerDeployment_Step3
      - CephStorageDeployedServerDeployment_Step3
    properties:
      name: {list_join: [".", ["tripleo", {get_param: stack_name}, "workflow_tasks", "step4"]]}
      type: direct
      tags:
      - tripleo-heat-templates-managed
      - {get_param: stack_name}
      tasks:
        yaql:
          expression: $.data.where($ != '').select($.get('step4')).where($ != null).flatten()
          data:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks]
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks]

  WorkflowTasks_Step4_Execution:
    type: OS::TripleO::WorkflowSteps
    condition: WorkflowTasks_Step4_Enabled
    depends_on: WorkflowTasks_Step4
    properties:
      actions:
        CREATE:
          workflow: { get_resource: WorkflowTasks_Step4 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
        UPDATE:
          workflow: { get_resource: WorkflowTasks_Step4 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
      always_update: true
# END workflow_tasks handling

# BEGIN workflow_tasks handling
  WorkflowTasks_Step5:
    type: OS::Mistral::Workflow
    condition: WorkflowTasks_Step5_Enabled
    depends_on:
      - ControllerDeployedServerDeployment_Step4
      - ComputeDeployedServerDeployment_Step4
      - BlockStorageDeployedServerDeployment_Step4
      - ObjectStorageDeployedServerDeployment_Step4
      - CephStorageDeployedServerDeployment_Step4
    properties:
      name: {list_join: [".", ["tripleo", {get_param: stack_name}, "workflow_tasks", "step5"]]}
      type: direct
      tags:
      - tripleo-heat-templates-managed
      - {get_param: stack_name}
      tasks:
        yaql:
          expression: $.data.where($ != '').select($.get('step5')).where($ != null).flatten()
          data:
            - get_param: [role_data, ControllerDeployedServer, workflow_tasks]
            - get_param: [role_data, ComputeDeployedServer, workflow_tasks]
            - get_param: [role_data, BlockStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, ObjectStorageDeployedServer, workflow_tasks]
            - get_param: [role_data, CephStorageDeployedServer, workflow_tasks]

  WorkflowTasks_Step5_Execution:
    type: OS::TripleO::WorkflowSteps
    condition: WorkflowTasks_Step5_Enabled
    depends_on: WorkflowTasks_Step5
    properties:
      actions:
        CREATE:
          workflow: { get_resource: WorkflowTasks_Step5 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
        UPDATE:
          workflow: { get_resource: WorkflowTasks_Step5 }
          params:
            env:
              heat_stack_name: { get_param: stack_name }
              service_ips: { get_param: ctlplane_service_ips }
              role_merged_configs:
                ControllerDeployedServer: {get_param: [role_data, ControllerDeployedServer, merged_config_settings]}
                ComputeDeployedServer: {get_param: [role_data, ComputeDeployedServer, merged_config_settings]}
                BlockStorageDeployedServer: {get_param: [role_data, BlockStorageDeployedServer, merged_config_settings]}
                ObjectStorageDeployedServer: {get_param: [role_data, ObjectStorageDeployedServer, merged_config_settings]}
                CephStorageDeployedServer: {get_param: [role_data, CephStorageDeployedServer, merged_config_settings]}
              blacklisted_ip_addresses: {get_param: blacklisted_ip_addresses}
              blacklisted_hostnames: {get_param: blacklisted_hostnames}
            evaluate_env: false
      always_update: true
# END workflow_tasks handling


  BootstrapServerId:
    type: OS::Heat::Value
    properties:
      value:
        yaql:
          expression: $.data.items().orderBy($[0]).first()[1]
          data: {get_param: [servers, ControllerDeployedServer]}

# Artifacts config and HostPrepConfig is done on all roles, not only
# enabled_roles, because on upgrade we need to write the json files
# for the operator driven upgrade scripts (the ansible steps consume them)

  # Prepare host tasks for ControllerDeployedServer
  ControllerDeployedServerArtifactsConfig:
    type: ../puppet/deploy-artifacts.yaml

  ControllerDeployedServerArtifactsDeploy:
    type: OS::Heat::StructuredDeploymentGroup
    properties:
      name: ControllerDeployedServerArtifactsDeploy
      servers:  {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: ControllerDeployedServerArtifactsConfig}

  ControllerDeployedServerHostPrepConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ansible
      options:
        modulepath: /usr/share/ansible-modules
      config:
        str_replace:
          template: _PLAYBOOK
          params:
            _PLAYBOOK:
              - hosts: localhost
                connection: local
                vars:
                  docker_puppet_script: {get_file: ../docker/docker-puppet.py}
                  bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
                tasks:
                  # Join host_prep_tasks with the other per-host configuration
                  list_concat:
                    - {get_param: [role_data, ControllerDeployedServer, host_prep_tasks]}
                    -
                      # FIXME: can we move docker-puppet somewhere so it's installed via a package?
                      - name: Create /var/lib/docker-puppet
                        file: path=/var/lib/docker-puppet state=directory setype=svirt_sandbox_file_t selevel=s0 recurse=true
                      - name: Write docker-puppet.py
                        copy: content="{{docker_puppet_script}}" dest=/var/lib/docker-puppet/docker-puppet.py force=yes mode=0600

  ControllerDeployedServerHostPrepDeployment:
    type: OS::Heat::SoftwareDeploymentGroup
    properties:
      name: ControllerDeployedServerHostPrepDeployment
      servers: {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: ControllerDeployedServerHostPrepConfig}

  # Prepare host tasks for ComputeDeployedServer
  ComputeDeployedServerArtifactsConfig:
    type: ../puppet/deploy-artifacts.yaml

  ComputeDeployedServerArtifactsDeploy:
    type: OS::Heat::StructuredDeploymentGroup
    properties:
      name: ComputeDeployedServerArtifactsDeploy
      servers:  {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: ComputeDeployedServerArtifactsConfig}

  ComputeDeployedServerHostPrepConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ansible
      options:
        modulepath: /usr/share/ansible-modules
      config:
        str_replace:
          template: _PLAYBOOK
          params:
            _PLAYBOOK:
              - hosts: localhost
                connection: local
                vars:
                  docker_puppet_script: {get_file: ../docker/docker-puppet.py}
                  bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
                tasks:
                  # Join host_prep_tasks with the other per-host configuration
                  list_concat:
                    - {get_param: [role_data, ComputeDeployedServer, host_prep_tasks]}
                    -
                      # FIXME: can we move docker-puppet somewhere so it's installed via a package?
                      - name: Create /var/lib/docker-puppet
                        file: path=/var/lib/docker-puppet state=directory setype=svirt_sandbox_file_t selevel=s0 recurse=true
                      - name: Write docker-puppet.py
                        copy: content="{{docker_puppet_script}}" dest=/var/lib/docker-puppet/docker-puppet.py force=yes mode=0600

  ComputeDeployedServerHostPrepDeployment:
    type: OS::Heat::SoftwareDeploymentGroup
    properties:
      name: ComputeDeployedServerHostPrepDeployment
      servers: {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: ComputeDeployedServerHostPrepConfig}

  # Prepare host tasks for BlockStorageDeployedServer
  BlockStorageDeployedServerArtifactsConfig:
    type: ../puppet/deploy-artifacts.yaml

  BlockStorageDeployedServerArtifactsDeploy:
    type: OS::Heat::StructuredDeploymentGroup
    properties:
      name: BlockStorageDeployedServerArtifactsDeploy
      servers:  {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: BlockStorageDeployedServerArtifactsConfig}

  BlockStorageDeployedServerHostPrepConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ansible
      options:
        modulepath: /usr/share/ansible-modules
      config:
        str_replace:
          template: _PLAYBOOK
          params:
            _PLAYBOOK:
              - hosts: localhost
                connection: local
                vars:
                  docker_puppet_script: {get_file: ../docker/docker-puppet.py}
                  bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
                tasks:
                  # Join host_prep_tasks with the other per-host configuration
                  list_concat:
                    - {get_param: [role_data, BlockStorageDeployedServer, host_prep_tasks]}
                    -
                      # FIXME: can we move docker-puppet somewhere so it's installed via a package?
                      - name: Create /var/lib/docker-puppet
                        file: path=/var/lib/docker-puppet state=directory setype=svirt_sandbox_file_t selevel=s0 recurse=true
                      - name: Write docker-puppet.py
                        copy: content="{{docker_puppet_script}}" dest=/var/lib/docker-puppet/docker-puppet.py force=yes mode=0600

  BlockStorageDeployedServerHostPrepDeployment:
    type: OS::Heat::SoftwareDeploymentGroup
    properties:
      name: BlockStorageDeployedServerHostPrepDeployment
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: BlockStorageDeployedServerHostPrepConfig}

  # Prepare host tasks for ObjectStorageDeployedServer
  ObjectStorageDeployedServerArtifactsConfig:
    type: ../puppet/deploy-artifacts.yaml

  ObjectStorageDeployedServerArtifactsDeploy:
    type: OS::Heat::StructuredDeploymentGroup
    properties:
      name: ObjectStorageDeployedServerArtifactsDeploy
      servers:  {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: ObjectStorageDeployedServerArtifactsConfig}

  ObjectStorageDeployedServerHostPrepConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ansible
      options:
        modulepath: /usr/share/ansible-modules
      config:
        str_replace:
          template: _PLAYBOOK
          params:
            _PLAYBOOK:
              - hosts: localhost
                connection: local
                vars:
                  docker_puppet_script: {get_file: ../docker/docker-puppet.py}
                  bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
                tasks:
                  # Join host_prep_tasks with the other per-host configuration
                  list_concat:
                    - {get_param: [role_data, ObjectStorageDeployedServer, host_prep_tasks]}
                    -
                      # FIXME: can we move docker-puppet somewhere so it's installed via a package?
                      - name: Create /var/lib/docker-puppet
                        file: path=/var/lib/docker-puppet state=directory setype=svirt_sandbox_file_t selevel=s0 recurse=true
                      - name: Write docker-puppet.py
                        copy: content="{{docker_puppet_script}}" dest=/var/lib/docker-puppet/docker-puppet.py force=yes mode=0600

  ObjectStorageDeployedServerHostPrepDeployment:
    type: OS::Heat::SoftwareDeploymentGroup
    properties:
      name: ObjectStorageDeployedServerHostPrepDeployment
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: ObjectStorageDeployedServerHostPrepConfig}

  # Prepare host tasks for CephStorageDeployedServer
  CephStorageDeployedServerArtifactsConfig:
    type: ../puppet/deploy-artifacts.yaml

  CephStorageDeployedServerArtifactsDeploy:
    type: OS::Heat::StructuredDeploymentGroup
    properties:
      name: CephStorageDeployedServerArtifactsDeploy
      servers:  {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: CephStorageDeployedServerArtifactsConfig}

  CephStorageDeployedServerHostPrepConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ansible
      options:
        modulepath: /usr/share/ansible-modules
      config:
        str_replace:
          template: _PLAYBOOK
          params:
            _PLAYBOOK:
              - hosts: localhost
                connection: local
                vars:
                  docker_puppet_script: {get_file: ../docker/docker-puppet.py}
                  bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
                tasks:
                  # Join host_prep_tasks with the other per-host configuration
                  list_concat:
                    - {get_param: [role_data, CephStorageDeployedServer, host_prep_tasks]}
                    -
                      # FIXME: can we move docker-puppet somewhere so it's installed via a package?
                      - name: Create /var/lib/docker-puppet
                        file: path=/var/lib/docker-puppet state=directory setype=svirt_sandbox_file_t selevel=s0 recurse=true
                      - name: Write docker-puppet.py
                        copy: content="{{docker_puppet_script}}" dest=/var/lib/docker-puppet/docker-puppet.py force=yes mode=0600

  CephStorageDeployedServerHostPrepDeployment:
    type: OS::Heat::SoftwareDeploymentGroup
    properties:
      name: CephStorageDeployedServerHostPrepDeployment
      servers: {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: CephStorageDeployedServerHostPrepConfig}


  # BEGIN CONFIG STEPS, only on enabled_roles
  ControllerDeployedServerPreConfig:
    type: OS::TripleO::Tasks::ControllerDeployedServerPreConfig
    depends_on: ControllerDeployedServerHostPrepDeployment
    properties:
      servers: {get_param: [servers, ControllerDeployedServer]}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  # Deployment steps for ControllerDeployedServer
  # A single config is re-applied with an incrementing step number
  
  ControllerDeployedServerDeployment_Step1:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step1_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerPreConfig
      - ControllerDeployedServerArtifactsDeploy
      - ComputeDeployedServerPreConfig
      - ComputeDeployedServerArtifactsDeploy
      - BlockStorageDeployedServerPreConfig
      - BlockStorageDeployedServerArtifactsDeploy
      - ObjectStorageDeployedServerPreConfig
      - ObjectStorageDeployedServerArtifactsDeploy
      - CephStorageDeployedServerPreConfig
      - CephStorageDeployedServerArtifactsDeploy
    properties:
      name: ControllerDeployedServerDeployment_Step1
      servers: {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 1
        role_name: ControllerDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ControllerDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ControllerDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ControllerDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ControllerDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ControllerDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ControllerDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ControllerDeployedServerDeployment_Step2:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step2_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step1
      - ComputeDeployedServerDeployment_Step1
      - BlockStorageDeployedServerDeployment_Step1
      - ObjectStorageDeployedServerDeployment_Step1
      - CephStorageDeployedServerDeployment_Step1
    properties:
      name: ControllerDeployedServerDeployment_Step2
      servers: {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 2
        role_name: ControllerDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ControllerDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ControllerDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ControllerDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ControllerDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ControllerDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ControllerDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ControllerDeployedServerDeployment_Step3:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step3_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step2
      - ComputeDeployedServerDeployment_Step2
      - BlockStorageDeployedServerDeployment_Step2
      - ObjectStorageDeployedServerDeployment_Step2
      - CephStorageDeployedServerDeployment_Step2
    properties:
      name: ControllerDeployedServerDeployment_Step3
      servers: {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 3
        role_name: ControllerDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ControllerDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ControllerDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ControllerDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ControllerDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ControllerDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ControllerDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ControllerDeployedServerDeployment_Step4:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step4_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step3
      - ComputeDeployedServerDeployment_Step3
      - BlockStorageDeployedServerDeployment_Step3
      - ObjectStorageDeployedServerDeployment_Step3
      - CephStorageDeployedServerDeployment_Step3
    properties:
      name: ControllerDeployedServerDeployment_Step4
      servers: {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 4
        role_name: ControllerDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ControllerDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ControllerDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ControllerDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ControllerDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ControllerDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ControllerDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ControllerDeployedServerDeployment_Step5:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step5_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step4
      - ComputeDeployedServerDeployment_Step4
      - BlockStorageDeployedServerDeployment_Step4
      - ObjectStorageDeployedServerDeployment_Step4
      - CephStorageDeployedServerDeployment_Step4
    properties:
      name: ControllerDeployedServerDeployment_Step5
      servers: {get_param: [servers, ControllerDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 5
        role_name: ControllerDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ControllerDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ControllerDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ControllerDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ControllerDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ControllerDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ControllerDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  # END CONFIG STEPS

  # Note, this should be the last step to execute configuration changes.
  # Ensure that all ControllerDeployedServerExtraConfigPost steps are executed
  # after all the previous deployment steps.
  ControllerDeployedServerExtraConfigPost:
    depends_on:
      - ControllerDeployedServerDeployment_Step5
      - ComputeDeployedServerDeployment_Step5
      - BlockStorageDeployedServerDeployment_Step5
      - ObjectStorageDeployedServerDeployment_Step5
      - CephStorageDeployedServerDeployment_Step5
    type: OS::TripleO::NodeExtraConfigPost
    properties:
        servers: {get_param: [servers, ControllerDeployedServer]}

  # The ControllerDeployedServerPostConfig steps are in charge of
  # quiescing all services, i.e. in the Controller case,
  # we should run a full service reload.
  ControllerDeployedServerPostConfig:
    type: OS::TripleO::Tasks::ControllerDeployedServerPostConfig
    depends_on:
      - ControllerDeployedServerExtraConfigPost
      - ComputeDeployedServerExtraConfigPost
      - BlockStorageDeployedServerExtraConfigPost
      - ObjectStorageDeployedServerExtraConfigPost
      - CephStorageDeployedServerExtraConfigPost
    properties:
      servers:  {get_param: servers}
      input_values:
        update_identifier: {get_param: DeployIdentifier}



  ComputeDeployedServerPreConfig:
    type: OS::TripleO::Tasks::ComputeDeployedServerPreConfig
    depends_on: ComputeDeployedServerHostPrepDeployment
    properties:
      servers: {get_param: [servers, ComputeDeployedServer]}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  # Deployment steps for ComputeDeployedServer
  # A single config is re-applied with an incrementing step number
  
  ComputeDeployedServerDeployment_Step1:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step1_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerPreConfig
      - ControllerDeployedServerArtifactsDeploy
      - ComputeDeployedServerPreConfig
      - ComputeDeployedServerArtifactsDeploy
      - BlockStorageDeployedServerPreConfig
      - BlockStorageDeployedServerArtifactsDeploy
      - ObjectStorageDeployedServerPreConfig
      - ObjectStorageDeployedServerArtifactsDeploy
      - CephStorageDeployedServerPreConfig
      - CephStorageDeployedServerArtifactsDeploy
    properties:
      name: ComputeDeployedServerDeployment_Step1
      servers: {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 1
        role_name: ComputeDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ComputeDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ComputeDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ComputeDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ComputeDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ComputeDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ComputeDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ComputeDeployedServerDeployment_Step2:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step2_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step1
      - ComputeDeployedServerDeployment_Step1
      - BlockStorageDeployedServerDeployment_Step1
      - ObjectStorageDeployedServerDeployment_Step1
      - CephStorageDeployedServerDeployment_Step1
    properties:
      name: ComputeDeployedServerDeployment_Step2
      servers: {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 2
        role_name: ComputeDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ComputeDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ComputeDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ComputeDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ComputeDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ComputeDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ComputeDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ComputeDeployedServerDeployment_Step3:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step3_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step2
      - ComputeDeployedServerDeployment_Step2
      - BlockStorageDeployedServerDeployment_Step2
      - ObjectStorageDeployedServerDeployment_Step2
      - CephStorageDeployedServerDeployment_Step2
    properties:
      name: ComputeDeployedServerDeployment_Step3
      servers: {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 3
        role_name: ComputeDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ComputeDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ComputeDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ComputeDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ComputeDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ComputeDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ComputeDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ComputeDeployedServerDeployment_Step4:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step4_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step3
      - ComputeDeployedServerDeployment_Step3
      - BlockStorageDeployedServerDeployment_Step3
      - ObjectStorageDeployedServerDeployment_Step3
      - CephStorageDeployedServerDeployment_Step3
    properties:
      name: ComputeDeployedServerDeployment_Step4
      servers: {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 4
        role_name: ComputeDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ComputeDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ComputeDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ComputeDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ComputeDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ComputeDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ComputeDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ComputeDeployedServerDeployment_Step5:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step5_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step4
      - ComputeDeployedServerDeployment_Step4
      - BlockStorageDeployedServerDeployment_Step4
      - ObjectStorageDeployedServerDeployment_Step4
      - CephStorageDeployedServerDeployment_Step4
    properties:
      name: ComputeDeployedServerDeployment_Step5
      servers: {get_param: [servers, ComputeDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 5
        role_name: ComputeDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ComputeDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ComputeDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ComputeDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ComputeDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ComputeDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ComputeDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  # END CONFIG STEPS

  # Note, this should be the last step to execute configuration changes.
  # Ensure that all ComputeDeployedServerExtraConfigPost steps are executed
  # after all the previous deployment steps.
  ComputeDeployedServerExtraConfigPost:
    depends_on:
      - ControllerDeployedServerDeployment_Step5
      - ComputeDeployedServerDeployment_Step5
      - BlockStorageDeployedServerDeployment_Step5
      - ObjectStorageDeployedServerDeployment_Step5
      - CephStorageDeployedServerDeployment_Step5
    type: OS::TripleO::NodeExtraConfigPost
    properties:
        servers: {get_param: [servers, ComputeDeployedServer]}

  # The ComputeDeployedServerPostConfig steps are in charge of
  # quiescing all services, i.e. in the Controller case,
  # we should run a full service reload.
  ComputeDeployedServerPostConfig:
    type: OS::TripleO::Tasks::ComputeDeployedServerPostConfig
    depends_on:
      - ControllerDeployedServerExtraConfigPost
      - ComputeDeployedServerExtraConfigPost
      - BlockStorageDeployedServerExtraConfigPost
      - ObjectStorageDeployedServerExtraConfigPost
      - CephStorageDeployedServerExtraConfigPost
    properties:
      servers:  {get_param: servers}
      input_values:
        update_identifier: {get_param: DeployIdentifier}



  BlockStorageDeployedServerPreConfig:
    type: OS::TripleO::Tasks::BlockStorageDeployedServerPreConfig
    depends_on: BlockStorageDeployedServerHostPrepDeployment
    properties:
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  # Deployment steps for BlockStorageDeployedServer
  # A single config is re-applied with an incrementing step number
  
  BlockStorageDeployedServerDeployment_Step1:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step1_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerPreConfig
      - ControllerDeployedServerArtifactsDeploy
      - ComputeDeployedServerPreConfig
      - ComputeDeployedServerArtifactsDeploy
      - BlockStorageDeployedServerPreConfig
      - BlockStorageDeployedServerArtifactsDeploy
      - ObjectStorageDeployedServerPreConfig
      - ObjectStorageDeployedServerArtifactsDeploy
      - CephStorageDeployedServerPreConfig
      - CephStorageDeployedServerArtifactsDeploy
    properties:
      name: BlockStorageDeployedServerDeployment_Step1
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 1
        role_name: BlockStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, BlockStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, BlockStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, BlockStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, BlockStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, BlockStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, BlockStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  BlockStorageDeployedServerDeployment_Step2:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step2_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step1
      - ComputeDeployedServerDeployment_Step1
      - BlockStorageDeployedServerDeployment_Step1
      - ObjectStorageDeployedServerDeployment_Step1
      - CephStorageDeployedServerDeployment_Step1
    properties:
      name: BlockStorageDeployedServerDeployment_Step2
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 2
        role_name: BlockStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, BlockStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, BlockStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, BlockStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, BlockStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, BlockStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, BlockStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  BlockStorageDeployedServerDeployment_Step3:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step3_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step2
      - ComputeDeployedServerDeployment_Step2
      - BlockStorageDeployedServerDeployment_Step2
      - ObjectStorageDeployedServerDeployment_Step2
      - CephStorageDeployedServerDeployment_Step2
    properties:
      name: BlockStorageDeployedServerDeployment_Step3
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 3
        role_name: BlockStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, BlockStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, BlockStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, BlockStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, BlockStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, BlockStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, BlockStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  BlockStorageDeployedServerDeployment_Step4:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step4_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step3
      - ComputeDeployedServerDeployment_Step3
      - BlockStorageDeployedServerDeployment_Step3
      - ObjectStorageDeployedServerDeployment_Step3
      - CephStorageDeployedServerDeployment_Step3
    properties:
      name: BlockStorageDeployedServerDeployment_Step4
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 4
        role_name: BlockStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, BlockStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, BlockStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, BlockStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, BlockStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, BlockStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, BlockStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  BlockStorageDeployedServerDeployment_Step5:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step5_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step4
      - ComputeDeployedServerDeployment_Step4
      - BlockStorageDeployedServerDeployment_Step4
      - ObjectStorageDeployedServerDeployment_Step4
      - CephStorageDeployedServerDeployment_Step4
    properties:
      name: BlockStorageDeployedServerDeployment_Step5
      servers: {get_param: [servers, BlockStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 5
        role_name: BlockStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, BlockStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, BlockStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, BlockStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, BlockStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, BlockStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, BlockStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  # END CONFIG STEPS

  # Note, this should be the last step to execute configuration changes.
  # Ensure that all BlockStorageDeployedServerExtraConfigPost steps are executed
  # after all the previous deployment steps.
  BlockStorageDeployedServerExtraConfigPost:
    depends_on:
      - ControllerDeployedServerDeployment_Step5
      - ComputeDeployedServerDeployment_Step5
      - BlockStorageDeployedServerDeployment_Step5
      - ObjectStorageDeployedServerDeployment_Step5
      - CephStorageDeployedServerDeployment_Step5
    type: OS::TripleO::NodeExtraConfigPost
    properties:
        servers: {get_param: [servers, BlockStorageDeployedServer]}

  # The BlockStorageDeployedServerPostConfig steps are in charge of
  # quiescing all services, i.e. in the Controller case,
  # we should run a full service reload.
  BlockStorageDeployedServerPostConfig:
    type: OS::TripleO::Tasks::BlockStorageDeployedServerPostConfig
    depends_on:
      - ControllerDeployedServerExtraConfigPost
      - ComputeDeployedServerExtraConfigPost
      - BlockStorageDeployedServerExtraConfigPost
      - ObjectStorageDeployedServerExtraConfigPost
      - CephStorageDeployedServerExtraConfigPost
    properties:
      servers:  {get_param: servers}
      input_values:
        update_identifier: {get_param: DeployIdentifier}



  ObjectStorageDeployedServerPreConfig:
    type: OS::TripleO::Tasks::ObjectStorageDeployedServerPreConfig
    depends_on: ObjectStorageDeployedServerHostPrepDeployment
    properties:
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  # Deployment steps for ObjectStorageDeployedServer
  # A single config is re-applied with an incrementing step number
  
  ObjectStorageDeployedServerDeployment_Step1:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step1_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerPreConfig
      - ControllerDeployedServerArtifactsDeploy
      - ComputeDeployedServerPreConfig
      - ComputeDeployedServerArtifactsDeploy
      - BlockStorageDeployedServerPreConfig
      - BlockStorageDeployedServerArtifactsDeploy
      - ObjectStorageDeployedServerPreConfig
      - ObjectStorageDeployedServerArtifactsDeploy
      - CephStorageDeployedServerPreConfig
      - CephStorageDeployedServerArtifactsDeploy
    properties:
      name: ObjectStorageDeployedServerDeployment_Step1
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 1
        role_name: ObjectStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ObjectStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ObjectStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ObjectStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ObjectStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ObjectStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ObjectStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ObjectStorageDeployedServerDeployment_Step2:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step2_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step1
      - ComputeDeployedServerDeployment_Step1
      - BlockStorageDeployedServerDeployment_Step1
      - ObjectStorageDeployedServerDeployment_Step1
      - CephStorageDeployedServerDeployment_Step1
    properties:
      name: ObjectStorageDeployedServerDeployment_Step2
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 2
        role_name: ObjectStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ObjectStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ObjectStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ObjectStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ObjectStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ObjectStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ObjectStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ObjectStorageDeployedServerDeployment_Step3:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step3_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step2
      - ComputeDeployedServerDeployment_Step2
      - BlockStorageDeployedServerDeployment_Step2
      - ObjectStorageDeployedServerDeployment_Step2
      - CephStorageDeployedServerDeployment_Step2
    properties:
      name: ObjectStorageDeployedServerDeployment_Step3
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 3
        role_name: ObjectStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ObjectStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ObjectStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ObjectStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ObjectStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ObjectStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ObjectStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ObjectStorageDeployedServerDeployment_Step4:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step4_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step3
      - ComputeDeployedServerDeployment_Step3
      - BlockStorageDeployedServerDeployment_Step3
      - ObjectStorageDeployedServerDeployment_Step3
      - CephStorageDeployedServerDeployment_Step3
    properties:
      name: ObjectStorageDeployedServerDeployment_Step4
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 4
        role_name: ObjectStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ObjectStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ObjectStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ObjectStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ObjectStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ObjectStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ObjectStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  ObjectStorageDeployedServerDeployment_Step5:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step5_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step4
      - ComputeDeployedServerDeployment_Step4
      - BlockStorageDeployedServerDeployment_Step4
      - ObjectStorageDeployedServerDeployment_Step4
      - CephStorageDeployedServerDeployment_Step4
    properties:
      name: ObjectStorageDeployedServerDeployment_Step5
      servers: {get_param: [servers, ObjectStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 5
        role_name: ObjectStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, ObjectStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, ObjectStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, ObjectStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, ObjectStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, ObjectStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, ObjectStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  # END CONFIG STEPS

  # Note, this should be the last step to execute configuration changes.
  # Ensure that all ObjectStorageDeployedServerExtraConfigPost steps are executed
  # after all the previous deployment steps.
  ObjectStorageDeployedServerExtraConfigPost:
    depends_on:
      - ControllerDeployedServerDeployment_Step5
      - ComputeDeployedServerDeployment_Step5
      - BlockStorageDeployedServerDeployment_Step5
      - ObjectStorageDeployedServerDeployment_Step5
      - CephStorageDeployedServerDeployment_Step5
    type: OS::TripleO::NodeExtraConfigPost
    properties:
        servers: {get_param: [servers, ObjectStorageDeployedServer]}

  # The ObjectStorageDeployedServerPostConfig steps are in charge of
  # quiescing all services, i.e. in the Controller case,
  # we should run a full service reload.
  ObjectStorageDeployedServerPostConfig:
    type: OS::TripleO::Tasks::ObjectStorageDeployedServerPostConfig
    depends_on:
      - ControllerDeployedServerExtraConfigPost
      - ComputeDeployedServerExtraConfigPost
      - BlockStorageDeployedServerExtraConfigPost
      - ObjectStorageDeployedServerExtraConfigPost
      - CephStorageDeployedServerExtraConfigPost
    properties:
      servers:  {get_param: servers}
      input_values:
        update_identifier: {get_param: DeployIdentifier}



  CephStorageDeployedServerPreConfig:
    type: OS::TripleO::Tasks::CephStorageDeployedServerPreConfig
    depends_on: CephStorageDeployedServerHostPrepDeployment
    properties:
      servers: {get_param: [servers, CephStorageDeployedServer]}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  # Deployment steps for CephStorageDeployedServer
  # A single config is re-applied with an incrementing step number
  
  CephStorageDeployedServerDeployment_Step1:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step1_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerPreConfig
      - ControllerDeployedServerArtifactsDeploy
      - ComputeDeployedServerPreConfig
      - ComputeDeployedServerArtifactsDeploy
      - BlockStorageDeployedServerPreConfig
      - BlockStorageDeployedServerArtifactsDeploy
      - ObjectStorageDeployedServerPreConfig
      - ObjectStorageDeployedServerArtifactsDeploy
      - CephStorageDeployedServerPreConfig
      - CephStorageDeployedServerArtifactsDeploy
    properties:
      name: CephStorageDeployedServerDeployment_Step1
      servers: {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 1
        role_name: CephStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, CephStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, CephStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, CephStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, CephStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, CephStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, CephStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  CephStorageDeployedServerDeployment_Step2:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step2_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step1
      - ComputeDeployedServerDeployment_Step1
      - BlockStorageDeployedServerDeployment_Step1
      - ObjectStorageDeployedServerDeployment_Step1
      - CephStorageDeployedServerDeployment_Step1
    properties:
      name: CephStorageDeployedServerDeployment_Step2
      servers: {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 2
        role_name: CephStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, CephStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, CephStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, CephStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, CephStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, CephStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, CephStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  CephStorageDeployedServerDeployment_Step3:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step3_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step2
      - ComputeDeployedServerDeployment_Step2
      - BlockStorageDeployedServerDeployment_Step2
      - ObjectStorageDeployedServerDeployment_Step2
      - CephStorageDeployedServerDeployment_Step2
    properties:
      name: CephStorageDeployedServerDeployment_Step3
      servers: {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 3
        role_name: CephStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, CephStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, CephStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, CephStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, CephStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, CephStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, CephStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  CephStorageDeployedServerDeployment_Step4:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step4_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step3
      - ComputeDeployedServerDeployment_Step3
      - BlockStorageDeployedServerDeployment_Step3
      - ObjectStorageDeployedServerDeployment_Step3
      - CephStorageDeployedServerDeployment_Step3
    properties:
      name: CephStorageDeployedServerDeployment_Step4
      servers: {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 4
        role_name: CephStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, CephStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, CephStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, CephStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, CephStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, CephStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, CephStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  CephStorageDeployedServerDeployment_Step5:
    type: OS::TripleO::DeploymentSteps
    depends_on:
      - WorkflowTasks_Step5_Execution
    # TODO(gfidente): the following if/else condition
    # replicates what is already defined for the
    # WorkflowTasks_StepX resource and can be remove
    # if https://bugs.launchpad.net/heat/+bug/1700569
    # is fixed.
      - ControllerDeployedServerDeployment_Step4
      - ComputeDeployedServerDeployment_Step4
      - BlockStorageDeployedServerDeployment_Step4
      - ObjectStorageDeployedServerDeployment_Step4
      - CephStorageDeployedServerDeployment_Step4
    properties:
      name: CephStorageDeployedServerDeployment_Step5
      servers: {get_param: [servers, CephStorageDeployedServer]}
      config: {get_resource: RoleConfig}
      input_values:
        step: 5
        role_name: CephStorageDeployedServer
        update_identifier: {get_param: DeployIdentifier}
        bootstrap_server_id: {get_attr: [BootstrapServerId, value]}
        enable_debug: {get_param: ConfigDebug}
        docker_puppet_debug: {get_param: DockerPuppetDebug}
        docker_puppet_process_count: {get_param: DockerPuppetProcessCount}
        role_data_step_config: {get_param: [role_data, CephStorageDeployedServer, step_config]}
        role_data_puppet_config: {get_param: [role_data, CephStorageDeployedServer, puppet_config]}
        role_data_docker_config_scripts: {get_param: [role_data, CephStorageDeployedServer, docker_config_scripts]}
        role_data_docker_puppet_tasks: {get_param: [role_data, CephStorageDeployedServer, docker_puppet_tasks]}
        role_data_docker_config: {get_param: [role_data, CephStorageDeployedServer, docker_config]}
        role_data_kolla_config: {get_param: [role_data, CephStorageDeployedServer, kolla_config]}
        deploy_steps_max: 6

  
  # END CONFIG STEPS

  # Note, this should be the last step to execute configuration changes.
  # Ensure that all CephStorageDeployedServerExtraConfigPost steps are executed
  # after all the previous deployment steps.
  CephStorageDeployedServerExtraConfigPost:
    depends_on:
      - ControllerDeployedServerDeployment_Step5
      - ComputeDeployedServerDeployment_Step5
      - BlockStorageDeployedServerDeployment_Step5
      - ObjectStorageDeployedServerDeployment_Step5
      - CephStorageDeployedServerDeployment_Step5
    type: OS::TripleO::NodeExtraConfigPost
    properties:
        servers: {get_param: [servers, CephStorageDeployedServer]}

  # The CephStorageDeployedServerPostConfig steps are in charge of
  # quiescing all services, i.e. in the Controller case,
  # we should run a full service reload.
  CephStorageDeployedServerPostConfig:
    type: OS::TripleO::Tasks::CephStorageDeployedServerPostConfig
    depends_on:
      - ControllerDeployedServerExtraConfigPost
      - ComputeDeployedServerExtraConfigPost
      - BlockStorageDeployedServerExtraConfigPost
      - ObjectStorageDeployedServerExtraConfigPost
      - CephStorageDeployedServerExtraConfigPost
    properties:
      servers:  {get_param: servers}
      input_values:
        update_identifier: {get_param: DeployIdentifier}




outputs:
  RoleConfig:
    description: Mapping of config data for all roles
    value:
      global_vars:
        deploy_steps_max: 6
        ssh_known_hosts: {get_param: ssh_known_hosts_hostnames}
      common_deploy_steps_tasks: {get_file: deploy-steps-tasks.yaml}
      docker_puppet_script: {get_file: ../docker/docker-puppet.py}
      deploy_steps_playbook:
        str_replace:
          params:
            BOOTSTRAP_SERVER_ID: {get_attr: [BootstrapServerId, value]}
          template: |
            - hosts: undercloud
              name: Gather facts undercloud
              gather_facts: yes
              become: false
              tags:
                - facts

            - hosts: overcloud
              name: Gather facts overcloud
              gather_facts: yes
              tags:
                - facts

            - hosts: all
              name: Load global variables
              gather_facts: no
              tasks:
                - include_vars: global_vars.yaml
              tags:
                - always

            - hosts: overcloud
              name: Common roles for TripleO servers
              gather_facts: no
              any_errors_fatal: yes
              roles:
                - tripleo-bootstrap
                - tripleo-ssh-known-hosts
              tags:
                - common_roles

            - hosts: ControllerDeployedServer:overcloud
              name: Server deployments
              gather_facts: no
              any_errors_fatal: yes
              tasks:
                - include: ControllerDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'ControllerDeployedServer'
                  with_items: "{{ ControllerDeployedServer_pre_deployments|default([]) }}"
                - include: ComputeDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'ComputeDeployedServer'
                  with_items: "{{ ComputeDeployedServer_pre_deployments|default([]) }}"
                - include: BlockStorageDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'BlockStorageDeployedServer'
                  with_items: "{{ BlockStorageDeployedServer_pre_deployments|default([]) }}"
                - include: ObjectStorageDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'ObjectStorageDeployedServer'
                  with_items: "{{ ObjectStorageDeployedServer_pre_deployments|default([]) }}"
                - include: CephStorageDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'CephStorageDeployedServer'
                  with_items: "{{ CephStorageDeployedServer_pre_deployments|default([]) }}"
              tags:
                - overcloud
                - pre_deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Host prep steps
              gather_facts: no
              any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
              become: true
              tasks:
                - include: ControllerDeployedServer/host_prep_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include: ComputeDeployedServer/host_prep_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include: BlockStorageDeployedServer/host_prep_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include: ObjectStorageDeployedServer/host_prep_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include: CephStorageDeployedServer/host_prep_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
              tags:
                - overcloud
                - host_prep_steps

            - hosts: undercloud
              name: External deployment step 1
              gather_facts: no
              any_errors_fatal: yes
              become: false
              vars:
                step: '1'
              tasks:
                - include: external_deploy_steps_tasks.yaml
              tags:
                - external
                - external_deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud deploy step tasks for 1
              gather_facts: no
              any_errors_fatal: yes
              # FIXME(shardy) - it would be nice to use strategy: free to
              # allow the tasks per-step to run in parallel on each role,
              # but that doesn't work with any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '1'
              tasks:
                - include: ControllerDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include: ComputeDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include: BlockStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include: ObjectStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include: CephStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
              tags:
                - overcloud
                - deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud common deploy step tasks 1
              gather_facts: no
              any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '1'
              tasks:
                - include: common_deploy_steps_tasks.yaml
              tags:
                - overcloud
                - deploy_steps

            - hosts: undercloud
              name: External deployment step 2
              gather_facts: no
              any_errors_fatal: yes
              become: false
              vars:
                step: '2'
              tasks:
                - include: external_deploy_steps_tasks.yaml
              tags:
                - external
                - external_deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud deploy step tasks for 2
              gather_facts: no
              any_errors_fatal: yes
              # FIXME(shardy) - it would be nice to use strategy: free to
              # allow the tasks per-step to run in parallel on each role,
              # but that doesn't work with any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '2'
              tasks:
                - include: ControllerDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include: ComputeDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include: BlockStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include: ObjectStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include: CephStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
              tags:
                - overcloud
                - deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud common deploy step tasks 2
              gather_facts: no
              any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '2'
              tasks:
                - include: common_deploy_steps_tasks.yaml
              tags:
                - overcloud
                - deploy_steps

            - hosts: undercloud
              name: External deployment step 3
              gather_facts: no
              any_errors_fatal: yes
              become: false
              vars:
                step: '3'
              tasks:
                - include: external_deploy_steps_tasks.yaml
              tags:
                - external
                - external_deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud deploy step tasks for 3
              gather_facts: no
              any_errors_fatal: yes
              # FIXME(shardy) - it would be nice to use strategy: free to
              # allow the tasks per-step to run in parallel on each role,
              # but that doesn't work with any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '3'
              tasks:
                - include: ControllerDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include: ComputeDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include: BlockStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include: ObjectStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include: CephStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
              tags:
                - overcloud
                - deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud common deploy step tasks 3
              gather_facts: no
              any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '3'
              tasks:
                - include: common_deploy_steps_tasks.yaml
              tags:
                - overcloud
                - deploy_steps

            - hosts: undercloud
              name: External deployment step 4
              gather_facts: no
              any_errors_fatal: yes
              become: false
              vars:
                step: '4'
              tasks:
                - include: external_deploy_steps_tasks.yaml
              tags:
                - external
                - external_deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud deploy step tasks for 4
              gather_facts: no
              any_errors_fatal: yes
              # FIXME(shardy) - it would be nice to use strategy: free to
              # allow the tasks per-step to run in parallel on each role,
              # but that doesn't work with any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '4'
              tasks:
                - include: ControllerDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include: ComputeDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include: BlockStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include: ObjectStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include: CephStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
              tags:
                - overcloud
                - deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud common deploy step tasks 4
              gather_facts: no
              any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '4'
              tasks:
                - include: common_deploy_steps_tasks.yaml
              tags:
                - overcloud
                - deploy_steps

            - hosts: undercloud
              name: External deployment step 5
              gather_facts: no
              any_errors_fatal: yes
              become: false
              vars:
                step: '5'
              tasks:
                - include: external_deploy_steps_tasks.yaml
              tags:
                - external
                - external_deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud deploy step tasks for 5
              gather_facts: no
              any_errors_fatal: yes
              # FIXME(shardy) - it would be nice to use strategy: free to
              # allow the tasks per-step to run in parallel on each role,
              # but that doesn't work with any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '5'
              tasks:
                - include: ControllerDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include: ComputeDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include: BlockStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include: ObjectStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include: CephStorageDeployedServer/deploy_steps_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
              tags:
                - overcloud
                - deploy_steps

            - hosts: ControllerDeployedServer:overcloud
              name: Overcloud common deploy step tasks 5
              gather_facts: no
              any_errors_fatal: yes
              vars:
                bootstrap_server_id: BOOTSTRAP_SERVER_ID
                step: '5'
              tasks:
                - include: common_deploy_steps_tasks.yaml
              tags:
                - overcloud
                - deploy_steps
            - hosts: ControllerDeployedServer:overcloud
              name: Server Post Deployments
              gather_facts: no
              any_errors_fatal: yes
              tasks:
                - include: ControllerDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'ControllerDeployedServer'
                  with_items: "{{ ControllerDeployedServer_post_deployments|default([]) }}"
                - include: ComputeDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'ComputeDeployedServer'
                  with_items: "{{ ComputeDeployedServer_post_deployments|default([]) }}"
                - include: BlockStorageDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'BlockStorageDeployedServer'
                  with_items: "{{ BlockStorageDeployedServer_post_deployments|default([]) }}"
                - include: ObjectStorageDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'ObjectStorageDeployedServer'
                  with_items: "{{ ObjectStorageDeployedServer_post_deployments|default([]) }}"
                - include: CephStorageDeployedServer/deployments.yaml
                  vars:
                    force: false
                  when: role_name == 'CephStorageDeployedServer'
                  with_items: "{{ CephStorageDeployedServer_post_deployments|default([]) }}"
              tags:
                - overcloud
                - post_deploy_steps

            - hosts: undercloud
              name: External deployment Post Deploy tasks
              gather_facts: no
              any_errors_fatal: yes
              become: false
              tasks:
                - include: external_post_deploy_steps_tasks.yaml
              tags:
                - external
                - external_deploy_steps

      external_deploy_steps_tasks: {get_attr: [ExternalDeployTasks, value]}
      external_post_deploy_steps_tasks: {get_attr: [ExternalPostDeployTasks, value]}
      update_steps_tasks: |
            - include: ControllerDeployedServer/update_tasks.yaml
              when: role_name == 'ControllerDeployedServer'
            - include: ComputeDeployedServer/update_tasks.yaml
              when: role_name == 'ComputeDeployedServer'
            - include: BlockStorageDeployedServer/update_tasks.yaml
              when: role_name == 'BlockStorageDeployedServer'
            - include: ObjectStorageDeployedServer/update_tasks.yaml
              when: role_name == 'ObjectStorageDeployedServer'
            - include: CephStorageDeployedServer/update_tasks.yaml
              when: role_name == 'CephStorageDeployedServer'
      update_steps_playbook: |
        - hosts: undercloud
          name: Gather facts undercloud
          gather_facts: yes
          become: false
        - hosts: overcloud
          name: Gather facts overcloud
          gather_facts: yes
        - hosts: all
          name: Load global variables
          gather_facts: no
          tasks:
            - include_vars: global_vars.yaml
        - hosts: overcloud
          name: Run update
          serial: 1
          gather_facts: no
          tasks:
            - include: update_steps_tasks.yaml
              with_sequence: start=0 end=5
              loop_control:
                loop_var: step
            - include: ControllerDeployedServer/host_prep_tasks.yaml
              when: role_name == 'ControllerDeployedServer'
            - include: ComputeDeployedServer/host_prep_tasks.yaml
              when: role_name == 'ComputeDeployedServer'
            - include: BlockStorageDeployedServer/host_prep_tasks.yaml
              when: role_name == 'BlockStorageDeployedServer'
            - include: ObjectStorageDeployedServer/host_prep_tasks.yaml
              when: role_name == 'ObjectStorageDeployedServer'
            - include: CephStorageDeployedServer/host_prep_tasks.yaml
              when: role_name == 'CephStorageDeployedServer'
            - include: common_deploy_steps_tasks.yaml
              with_sequence: start=1 end=5
              loop_control:
                loop_var: step
            - include: post_update_steps_tasks.yaml
              with_sequence: start=0 end=3
              loop_control:
                loop_var: step
      pre_upgrade_rolling_steps_tasks: |
            - include: ControllerDeployedServer/pre_upgrade_rolling_tasks.yaml
              when: role_name == 'ControllerDeployedServer'
            - include: ComputeDeployedServer/pre_upgrade_rolling_tasks.yaml
              when: role_name == 'ComputeDeployedServer'
            - include: BlockStorageDeployedServer/pre_upgrade_rolling_tasks.yaml
              when: role_name == 'BlockStorageDeployedServer'
            - include: ObjectStorageDeployedServer/pre_upgrade_rolling_tasks.yaml
              when: role_name == 'ObjectStorageDeployedServer'
            - include: CephStorageDeployedServer/pre_upgrade_rolling_tasks.yaml
              when: role_name == 'CephStorageDeployedServer'
      pre_upgrade_rolling_steps_playbook: |
        - hosts: undercloud
          name: Gather facts undercloud
          gather_facts: yes
          become: false
        - hosts: overcloud
          name: Gather facts overcloud
          gather_facts: yes
        - hosts: all
          name: Load global variables
          gather_facts: no
          tasks:
            - include_vars: global_vars.yaml
        - hosts: overcloud
          name: Run pre-upgrade rolling tasks
          serial: 1
          gather_facts: no
          tasks:
            - include: pre_upgrade_rolling_steps_tasks.yaml
              with_sequence: start=0 end=0
              loop_control:
                loop_var: step
      upgrade_steps_tasks: |
            - include: ControllerDeployedServer/upgrade_tasks.yaml
              when: role_name == 'ControllerDeployedServer'
            - include: ComputeDeployedServer/upgrade_tasks.yaml
              when: role_name == 'ComputeDeployedServer'
            - include: BlockStorageDeployedServer/upgrade_tasks.yaml
              when: role_name == 'BlockStorageDeployedServer'
            - include: ObjectStorageDeployedServer/upgrade_tasks.yaml
              when: role_name == 'ObjectStorageDeployedServer'
            - include: CephStorageDeployedServer/upgrade_tasks.yaml
              when: role_name == 'CephStorageDeployedServer'
      upgrade_steps_playbook: |
        - hosts: overcloud
          tasks:
            - include: upgrade_steps_tasks.yaml
              with_sequence: start=0 end=5
              loop_control:
                loop_var: step
      post_upgrade_steps_tasks: |
            - include: ControllerDeployedServer/post_upgrade_tasks.yaml
              when: role_name == 'ControllerDeployedServer'
            - include: ComputeDeployedServer/post_upgrade_tasks.yaml
              when: role_name == 'ComputeDeployedServer'
            - include: BlockStorageDeployedServer/post_upgrade_tasks.yaml
              when: role_name == 'BlockStorageDeployedServer'
            - include: ObjectStorageDeployedServer/post_upgrade_tasks.yaml
              when: role_name == 'ObjectStorageDeployedServer'
            - include: CephStorageDeployedServer/post_upgrade_tasks.yaml
              when: role_name == 'CephStorageDeployedServer'
      post_upgrade_steps_playbook: |
        - hosts: overcloud
          tasks:
            - include: post_upgrade_steps_tasks.yaml
              with_sequence: start=0 end=3
              loop_control:
                loop_var: step
      fast_forward_upgrade_playbook:
        - hosts: overcloud
          become: true
          tasks:
            - set_fact:
                releases: {get_param: [FastForwardUpgradeReleases]}

            - set_fact:
                ffu_releases: "{{ releases | difference( releases | last )}}"
            - include_tasks: fast_forward_upgrade_release_tasks.yaml
              loop_control:
                loop_var: release
              with_items: '{{ ffu_releases }}'
            - set_fact:
                release: "{{ releases | last }}"
                ffu_packages_apply: True

            - include_tasks: fast_forward_upgrade_post_role_tasks.yaml
      fast_forward_upgrade_release_tasks: |
                - include_tasks: fast_forward_upgrade_prep_tasks.yaml
                - include_tasks: fast_forward_upgrade_bootstrap_tasks.yaml
      fast_forward_upgrade_prep_tasks: |
                - shell: |
                    #!/bin/bash
                    if [ ! -f /root/.ffu_workaround ]; then
                      touch /root/.ffu_workaround
                      os-apply-config -m /var/lib/os-collect-config/ControllerDeployedServerDeployment.json
                      systemctl stop os-collect-config
                      rm -r /var/lib/os-collect-config/*
                      rm -f /usr/libexec/os-refresh-config/configure.d/40-hiera-datafiles
                      rm -f /usr/libexec/os-apply-config/templates/etc/puppet/hiera.yaml
                      rm -f /usr/libexec/os-refresh-config/configure.d/10-hiera-disable
                    fi
                  when: role_name == 'ControllerDeployedServer'
                  name: Run Fast Forward Upgrade Prep Workarounds for ControllerDeployedServer
                - shell: |
                    #!/bin/bash
                    if [ ! -f /root/.ffu_workaround ]; then
                      touch /root/.ffu_workaround
                      os-apply-config -m /var/lib/os-collect-config/ComputeDeployedServerDeployment.json
                      systemctl stop os-collect-config
                      rm -r /var/lib/os-collect-config/*
                      rm -f /usr/libexec/os-refresh-config/configure.d/40-hiera-datafiles
                      rm -f /usr/libexec/os-apply-config/templates/etc/puppet/hiera.yaml
                      rm -f /usr/libexec/os-refresh-config/configure.d/10-hiera-disable
                    fi
                  when: role_name == 'ComputeDeployedServer'
                  name: Run Fast Forward Upgrade Prep Workarounds for ComputeDeployedServer
                - shell: |
                    #!/bin/bash
                    if [ ! -f /root/.ffu_workaround ]; then
                      touch /root/.ffu_workaround
                      os-apply-config -m /var/lib/os-collect-config/BlockStorageDeployedServerDeployment.json
                      systemctl stop os-collect-config
                      rm -r /var/lib/os-collect-config/*
                      rm -f /usr/libexec/os-refresh-config/configure.d/40-hiera-datafiles
                      rm -f /usr/libexec/os-apply-config/templates/etc/puppet/hiera.yaml
                      rm -f /usr/libexec/os-refresh-config/configure.d/10-hiera-disable
                    fi
                  when: role_name == 'BlockStorageDeployedServer'
                  name: Run Fast Forward Upgrade Prep Workarounds for BlockStorageDeployedServer
                - shell: |
                    #!/bin/bash
                    if [ ! -f /root/.ffu_workaround ]; then
                      touch /root/.ffu_workaround
                      os-apply-config -m /var/lib/os-collect-config/ObjectStorageDeployedServerDeployment.json
                      systemctl stop os-collect-config
                      rm -r /var/lib/os-collect-config/*
                      rm -f /usr/libexec/os-refresh-config/configure.d/40-hiera-datafiles
                      rm -f /usr/libexec/os-apply-config/templates/etc/puppet/hiera.yaml
                      rm -f /usr/libexec/os-refresh-config/configure.d/10-hiera-disable
                    fi
                  when: role_name == 'ObjectStorageDeployedServer'
                  name: Run Fast Forward Upgrade Prep Workarounds for ObjectStorageDeployedServer
                - shell: |
                    #!/bin/bash
                    if [ ! -f /root/.ffu_workaround ]; then
                      touch /root/.ffu_workaround
                      os-apply-config -m /var/lib/os-collect-config/CephStorageDeployedServerDeployment.json
                      systemctl stop os-collect-config
                      rm -r /var/lib/os-collect-config/*
                      rm -f /usr/libexec/os-refresh-config/configure.d/40-hiera-datafiles
                      rm -f /usr/libexec/os-apply-config/templates/etc/puppet/hiera.yaml
                      rm -f /usr/libexec/os-refresh-config/configure.d/10-hiera-disable
                    fi
                  when: role_name == 'CephStorageDeployedServer'
                  name: Run Fast Forward Upgrade Prep Workarounds for CephStorageDeployedServer

                - name: get bootstrap nodeid
                  tags: common
                  command: hiera -c /etc/puppet/hiera.yaml bootstrap_nodeid
                  register: bootstrap_node
                - name: set is_bootstrap_node ffu_packages_bootstrap_only facts
                  tags: common
                  set_fact:
                    is_bootstrap_node={{bootstrap_node.stdout|lower == ansible_hostname|lower}}
                    ffu_packages_apply={{bootstrap_node.stdout|lower == ansible_hostname|lower}}

                - name: Create /var/lib/docker-puppet
                  file: path=/var/lib/docker-puppet state=directory setype=svirt_sandbox_file_t selevel=s0 recurse=true
                - name: Write docker-puppet.py
                  copy: src=docker_puppet_script.yaml dest=/var/lib/docker-puppet/docker-puppet.py force=yes mode=0600
                - include_tasks: fast_forward_upgrade_prep_role_tasks.yaml
                  with_sequence: start=0 end=3
                  loop_control:
                    loop_var: step
      fast_forward_upgrade_post_role_tasks: |
                - include_tasks: ControllerDeployedServer/fast_forward_post_upgrade_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include_tasks: ComputeDeployedServer/fast_forward_post_upgrade_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include_tasks: BlockStorageDeployedServer/fast_forward_post_upgrade_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include_tasks: ObjectStorageDeployedServer/fast_forward_post_upgrade_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include_tasks: CephStorageDeployedServer/fast_forward_post_upgrade_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
                - name: Openstack Heat Agents package update
                  yum: name=openstack-heat-agents state=latest
                - name: Update os-collect-config
                  yum: name=os-collect-config state=latest
                - name: Start os-collect-config back up
                  service: name=os-collect-config state=started enabled=yes
      fast_forward_upgrade_prep_role_tasks: |
                - include_tasks: ControllerDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'ControllerDeployedServer'
                - include_tasks: ComputeDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'ComputeDeployedServer'
                - include_tasks: BlockStorageDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer'
                - include_tasks: ObjectStorageDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer'
                - include_tasks: CephStorageDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer'
      fast_forward_upgrade_bootstrap_tasks: |
                - include_tasks: fast_forward_upgrade_bootstrap_role_tasks.yaml
                  with_sequence: start=4 end=9
                  loop_control:
                    loop_var: step
      fast_forward_upgrade_bootstrap_role_tasks: |
                - include_tasks: ControllerDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'ControllerDeployedServer' and ansible_hostname == ControllerDeployedServer[0]
                - include_tasks: ComputeDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'ComputeDeployedServer' and ansible_hostname == ComputeDeployedServer[0]
                - include_tasks: BlockStorageDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'BlockStorageDeployedServer' and ansible_hostname == BlockStorageDeployedServer[0]
                - include_tasks: ObjectStorageDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'ObjectStorageDeployedServer' and ansible_hostname == ObjectStorageDeployedServer[0]
                - include_tasks: CephStorageDeployedServer/fast_forward_upgrade_tasks.yaml
                  when: role_name == 'CephStorageDeployedServer' and ansible_hostname == CephStorageDeployedServer[0]
      post_update_steps_tasks: |
            - include: ControllerDeployedServer/post_update_tasks.yaml
              when: role_name == 'ControllerDeployedServer'
            - include: ComputeDeployedServer/post_update_tasks.yaml
              when: role_name == 'ComputeDeployedServer'
            - include: BlockStorageDeployedServer/post_update_tasks.yaml
              when: role_name == 'BlockStorageDeployedServer'
            - include: ObjectStorageDeployedServer/post_update_tasks.yaml
              when: role_name == 'ObjectStorageDeployedServer'
            - include: CephStorageDeployedServer/post_update_tasks.yaml
              when: role_name == 'CephStorageDeployedServer'